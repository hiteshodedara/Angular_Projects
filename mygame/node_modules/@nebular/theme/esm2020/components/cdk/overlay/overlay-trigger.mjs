import { Inject, Injectable } from '@angular/core';
import { EMPTY, fromEvent as observableFromEvent, merge as observableMerge, Subject } from 'rxjs';
import { debounceTime, delay, filter, map, repeat, share, switchMap, takeUntil, takeWhile } from 'rxjs/operators';
import { NB_DOCUMENT } from '../../../theme.options';
import * as i0 from "@angular/core";
export var NbTrigger;
(function (NbTrigger) {
    NbTrigger["NOOP"] = "noop";
    NbTrigger["CLICK"] = "click";
    NbTrigger["HOVER"] = "hover";
    NbTrigger["HINT"] = "hint";
    NbTrigger["FOCUS"] = "focus";
})(NbTrigger || (NbTrigger = {}));
/**
 * TODO maybe we have to use renderer.listen instead of observableFromEvent?
 * Renderer provides capability use it in service worker, ssr and so on.
 * */
export class NbTriggerStrategyBase {
    destroy() {
        this.destroyed$.next();
    }
    isNotOnHostOrContainer(element) {
        return !this.isOnHost(element) && !this.isOnContainer(element);
    }
    isOnHostOrContainer(element) {
        return this.isOnHost(element) || this.isOnContainer(element);
    }
    isOnHost(element) {
        return this.host.contains(element);
    }
    isOnContainer(element) {
        return this.container() && this.container().location.nativeElement.contains(element);
    }
    constructor(document, host, container) {
        this.document = document;
        this.host = host;
        this.container = container;
        this.destroyed$ = new Subject();
    }
}
/**
 * Creates show and hide event streams.
 * Fires toggle event when the click was performed on the host element.
 * Fires close event when the click was performed on the document but
 * not on the host or container.
 * */
export class NbClickTriggerStrategy extends NbTriggerStrategyBase {
    constructor() {
        super(...arguments);
        // since we should track click for both SHOW and HIDE event we firstly need to track the click and the state
        // of the container and then later on decide should we hide it or show
        // if we track the click & state separately this will case a behavior when the container is getting shown
        // and then hidden right away
        this.click$ = observableFromEvent(this.document, 'click').pipe(map((event) => [!this.container() && this.isOnHost(event.target), event]), share(), takeUntil(this.destroyed$));
        this.show$ = this.click$.pipe(filter(([shouldShow]) => shouldShow), map(([, event]) => event), takeUntil(this.destroyed$));
        this.hide$ = this.click$.pipe(filter(([shouldShow, event]) => !shouldShow && !this.isOnContainer(event.target)), map(([, event]) => event), takeUntil(this.destroyed$));
    }
}
/**
 * Creates show and hide event streams.
 * Fires open event when a mouse hovers over the host element and stay over at least 100 milliseconds.
 * Fires close event when the mouse leaves the host element and stops out of the host and popover container.
 * */
export class NbHoverTriggerStrategy extends NbTriggerStrategyBase {
    constructor() {
        super(...arguments);
        this.show$ = observableFromEvent(this.host, 'mouseenter').pipe(filter(() => !this.container()), 
        // this `delay & takeUntil & repeat` operators combination is a synonym for `conditional debounce`
        // meaning that if one event occurs in some time after the initial one we won't react to it
        delay(100), 
        // eslint-disable-next-line rxjs/no-unsafe-takeuntil
        takeUntil(observableFromEvent(this.host, 'mouseleave')), repeat(), takeUntil(this.destroyed$));
        this.hide$ = observableFromEvent(this.host, 'mouseleave').pipe(switchMap(() => observableFromEvent(this.document, 'mousemove').pipe(debounceTime(100), takeWhile(() => !!this.container()), filter((event) => this.isNotOnHostOrContainer(event.target)))), takeUntil(this.destroyed$));
    }
}
/**
 * Creates show and hide event streams.
 * Fires open event when a mouse hovers over the host element and stay over at least 100 milliseconds.
 * Fires close event when the mouse leaves the host element.
 * */
export class NbHintTriggerStrategy extends NbTriggerStrategyBase {
    constructor() {
        super(...arguments);
        this.show$ = observableFromEvent(this.host, 'mouseenter').pipe(
        // this `delay & takeUntil & repeat` operators combination is a synonym for `conditional debounce`
        // meaning that if one event occurs in some time after the initial one we won't react to it
        delay(100), 
        // eslint-disable-next-line rxjs/no-unsafe-takeuntil
        takeUntil(observableFromEvent(this.host, 'mouseleave')), repeat(), takeUntil(this.destroyed$));
        this.hide$ = observableFromEvent(this.host, 'mouseleave').pipe(takeUntil(this.destroyed$));
    }
}
/**
 * Creates show and hide event streams.
 * Fires open event when a focus is on the host element and stay over at least 100 milliseconds.
 * Fires close event when the focus leaves the host element.
 * */
export class NbFocusTriggerStrategy extends NbTriggerStrategyBase {
    constructor() {
        super(...arguments);
        this.focusOut$ = observableFromEvent(this.host, 'focusout').pipe(switchMap(() => observableFromEvent(this.document, 'focusin').pipe(takeWhile(() => !!this.container()), filter((event) => this.isNotOnHostOrContainer(event.target)))), takeUntil(this.destroyed$));
        this.clickIn$ = observableFromEvent(this.host, 'click').pipe(filter(() => !this.container()), takeUntil(this.destroyed$));
        this.clickOut$ = observableFromEvent(this.document, 'click').pipe(filter(() => !!this.container()), 
        /**
         * Event target of `click` could be different from `activeElement`.
         * If during click you return focus to the host, it won't be opened.
         */
        filter((event) => {
            if (this.isNotOnHostOrContainer(event.target)) {
                return this.isNotOnHostOrContainer(this.document.activeElement);
            }
            return false;
        }), takeUntil(this.destroyed$));
        this.tabKeyPress$ = observableFromEvent(this.document, 'keydown').pipe(filter((event) => event.keyCode === 9), filter(() => !!this.container()), takeUntil(this.destroyed$));
        this.show$ = observableMerge(observableFromEvent(this.host, 'focusin'), this.clickIn$).pipe(filter(() => !this.container()), debounceTime(100), 
        // eslint-disable-next-line rxjs/no-unsafe-takeuntil
        takeUntil(observableFromEvent(this.host, 'focusout')), repeat(), takeUntil(this.destroyed$));
        this.hide$ = observableMerge(this.focusOut$, this.tabKeyPress$, this.clickOut$).pipe(takeUntil(this.destroyed$));
    }
}
/**
 * Creates empty show and hide event streams.
 * */
export class NbNoopTriggerStrategy extends NbTriggerStrategyBase {
    constructor() {
        super(...arguments);
        this.show$ = EMPTY;
        this.hide$ = EMPTY;
    }
}
export class NbTriggerStrategyBuilderService {
    constructor(_document) {
        this._document = _document;
    }
    trigger(trigger) {
        this._trigger = trigger;
        return this;
    }
    host(host) {
        this._host = host;
        return this;
    }
    container(container) {
        this._container = container;
        return this;
    }
    build() {
        switch (this._trigger) {
            case NbTrigger.CLICK:
                return new NbClickTriggerStrategy(this._document, this._host, this._container);
            case NbTrigger.HINT:
                return new NbHintTriggerStrategy(this._document, this._host, this._container);
            case NbTrigger.HOVER:
                return new NbHoverTriggerStrategy(this._document, this._host, this._container);
            case NbTrigger.FOCUS:
                return new NbFocusTriggerStrategy(this._document, this._host, this._container);
            case NbTrigger.NOOP:
                return new NbNoopTriggerStrategy(this._document, this._host, this._container);
            default:
                throw new Error('Trigger have to be provided');
        }
    }
}
NbTriggerStrategyBuilderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: NbTriggerStrategyBuilderService, deps: [{ token: NB_DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
NbTriggerStrategyBuilderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: NbTriggerStrategyBuilderService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: NbTriggerStrategyBuilderService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [NB_DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS10cmlnZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay90aGVtZS9jb21wb25lbnRzL2Nkay9vdmVybGF5L292ZXJsYXktdHJpZ2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLElBQUksbUJBQW1CLEVBQUUsS0FBSyxJQUFJLGVBQWUsRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUcsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEgsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFDOztBQUdyRCxNQUFNLENBQU4sSUFBWSxTQU1YO0FBTkQsV0FBWSxTQUFTO0lBQ25CLDBCQUFhLENBQUE7SUFDYiw0QkFBZSxDQUFBO0lBQ2YsNEJBQWUsQ0FBQTtJQUNmLDBCQUFhLENBQUE7SUFDYiw0QkFBZSxDQUFBO0FBQ2pCLENBQUMsRUFOVyxTQUFTLEtBQVQsU0FBUyxRQU1wQjtBQWNEOzs7S0FHSztBQUNMLE1BQU0sT0FBZ0IscUJBQXFCO0lBQ3pDLE9BQU87UUFDTCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFJUyxzQkFBc0IsQ0FBQyxPQUFnQjtRQUMvQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVTLG1CQUFtQixDQUFDLE9BQWdCO1FBQzVDLE9BQU8s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QUFDLENBQUM7WUFDaEY7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1NBQ2xEO0lBQ0gsQ0FBQzs7NEhBckNVLCtCQUErQixrQkFLdEIsV0FBVztnSUFMcEIsK0JBQStCOzJGQUEvQiwrQkFBK0I7a0JBRDNDLFVBQVU7OzBCQU1JLE1BQU07MkJBQUMsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFTVBUWSwgZnJvbUV2ZW50IGFzIG9ic2VydmFibGVGcm9tRXZlbnQsIG1lcmdlIGFzIG9ic2VydmFibGVNZXJnZSwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBkZWxheSwgZmlsdGVyLCBtYXAsIHJlcGVhdCwgc2hhcmUsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YWtlV2hpbGUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOQl9ET0NVTUVOVCB9IGZyb20gJy4uLy4uLy4uL3RoZW1lLm9wdGlvbnMnO1xuXG5leHBvcnQgdHlwZSBOYlRyaWdnZXJWYWx1ZXMgPSAnbm9vcCcgfCAnY2xpY2snIHwgJ2hvdmVyJyB8ICdoaW50JyB8ICdmb2N1cyc7XG5leHBvcnQgZW51bSBOYlRyaWdnZXIge1xuICBOT09QID0gJ25vb3AnLFxuICBDTElDSyA9ICdjbGljaycsXG4gIEhPVkVSID0gJ2hvdmVyJyxcbiAgSElOVCA9ICdoaW50JyxcbiAgRk9DVVMgPSAnZm9jdXMnLFxufVxuXG4vKipcbiAqIFByb3ZpZGVzIGVudGl0eSB3aXRoIHR3byBldmVudCBzdHJlYW06IHNob3cgYW5kIGhpZGUuXG4gKiBFYWNoIHN0cmVhbSBwcm92aWRlcyBkaWZmZXJlbnQgZXZlbnRzIGRlcGVuZHMgb24gaW1wbGVtZW50YXRpb24uXG4gKiBXZSBoYXZlIHRocmVlIG1haW4gdHJpZ2dlciBzdHJhdGVnaWVzOiBjbGljaywgaGludCBhbmQgaG92ZXIuXG4gKiAqL1xuZXhwb3J0IGludGVyZmFjZSBOYlRyaWdnZXJTdHJhdGVneSB7XG4gIHNob3ckOiBPYnNlcnZhYmxlPG5ldmVyIHwgRXZlbnQ+O1xuICBoaWRlJDogT2JzZXJ2YWJsZTxuZXZlciB8IEV2ZW50PjtcblxuICBkZXN0cm95KCk7XG59XG5cbi8qKlxuICogVE9ETyBtYXliZSB3ZSBoYXZlIHRvIHVzZSByZW5kZXJlci5saXN0ZW4gaW5zdGVhZCBvZiBvYnNlcnZhYmxlRnJvbUV2ZW50P1xuICogUmVuZGVyZXIgcHJvdmlkZXMgY2FwYWJpbGl0eSB1c2UgaXQgaW4gc2VydmljZSB3b3JrZXIsIHNzciBhbmQgc28gb24uXG4gKiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE5iVHJpZ2dlclN0cmF0ZWd5QmFzZSBpbXBsZW1lbnRzIE5iVHJpZ2dlclN0cmF0ZWd5IHtcbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3llZCQubmV4dCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRlc3Ryb3llZCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIHByb3RlY3RlZCBpc05vdE9uSG9zdE9yQ29udGFpbmVyKGVsZW1lbnQ6IEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuaXNPbkhvc3QoZWxlbWVudCkgJiYgIXRoaXMuaXNPbkNvbnRhaW5lcihlbGVtZW50KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpc09uSG9zdE9yQ29udGFpbmVyKGVsZW1lbnQ6IEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pc09uSG9zdChlbGVtZW50KSB8fCB0aGlzLmlzT25Db250YWluZXIoZWxlbWVudCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgaXNPbkhvc3QoZWxlbWVudDogRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmhvc3QuY29udGFpbnMoZWxlbWVudCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgaXNPbkNvbnRhaW5lcihlbGVtZW50OiBFbGVtZW50KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGFpbmVyKCkgJiYgdGhpcy5jb250YWluZXIoKS5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGVsZW1lbnQpO1xuICB9XG5cbiAgYWJzdHJhY3Qgc2hvdyQ6IE9ic2VydmFibGU8RXZlbnQ+O1xuICBhYnN0cmFjdCBoaWRlJDogT2JzZXJ2YWJsZTxFdmVudD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGRvY3VtZW50OiBEb2N1bWVudCxcbiAgICBwcm90ZWN0ZWQgaG9zdDogSFRNTEVsZW1lbnQsXG4gICAgcHJvdGVjdGVkIGNvbnRhaW5lcjogKCkgPT4gQ29tcG9uZW50UmVmPGFueT4sXG4gICkge31cbn1cblxuLyoqXG4gKiBDcmVhdGVzIHNob3cgYW5kIGhpZGUgZXZlbnQgc3RyZWFtcy5cbiAqIEZpcmVzIHRvZ2dsZSBldmVudCB3aGVuIHRoZSBjbGljayB3YXMgcGVyZm9ybWVkIG9uIHRoZSBob3N0IGVsZW1lbnQuXG4gKiBGaXJlcyBjbG9zZSBldmVudCB3aGVuIHRoZSBjbGljayB3YXMgcGVyZm9ybWVkIG9uIHRoZSBkb2N1bWVudCBidXRcbiAqIG5vdCBvbiB0aGUgaG9zdCBvciBjb250YWluZXIuXG4gKiAqL1xuZXhwb3J0IGNsYXNzIE5iQ2xpY2tUcmlnZ2VyU3RyYXRlZ3kgZXh0ZW5kcyBOYlRyaWdnZXJTdHJhdGVneUJhc2Uge1xuICAvLyBzaW5jZSB3ZSBzaG91bGQgdHJhY2sgY2xpY2sgZm9yIGJvdGggU0hPVyBhbmQgSElERSBldmVudCB3ZSBmaXJzdGx5IG5lZWQgdG8gdHJhY2sgdGhlIGNsaWNrIGFuZCB0aGUgc3RhdGVcbiAgLy8gb2YgdGhlIGNvbnRhaW5lciBhbmQgdGhlbiBsYXRlciBvbiBkZWNpZGUgc2hvdWxkIHdlIGhpZGUgaXQgb3Igc2hvd1xuICAvLyBpZiB3ZSB0cmFjayB0aGUgY2xpY2sgJiBzdGF0ZSBzZXBhcmF0ZWx5IHRoaXMgd2lsbCBjYXNlIGEgYmVoYXZpb3Igd2hlbiB0aGUgY29udGFpbmVyIGlzIGdldHRpbmcgc2hvd25cbiAgLy8gYW5kIHRoZW4gaGlkZGVuIHJpZ2h0IGF3YXlcbiAgcHJvdGVjdGVkIGNsaWNrJDogT2JzZXJ2YWJsZTxbYm9vbGVhbiwgRXZlbnRdPiA9IG9ic2VydmFibGVGcm9tRXZlbnQ8RXZlbnQ+KHRoaXMuZG9jdW1lbnQsICdjbGljaycpLnBpcGUoXG4gICAgbWFwKChldmVudDogRXZlbnQpID0+IFshdGhpcy5jb250YWluZXIoKSAmJiB0aGlzLmlzT25Ib3N0KGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KSwgZXZlbnRdIGFzIFtib29sZWFuLCBFdmVudF0pLFxuICAgIHNoYXJlKCksXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICk7XG5cbiAgcmVhZG9ubHkgc2hvdyQ6IE9ic2VydmFibGU8RXZlbnQ+ID0gdGhpcy5jbGljayQucGlwZShcbiAgICBmaWx0ZXIoKFtzaG91bGRTaG93XSkgPT4gc2hvdWxkU2hvdyksXG4gICAgbWFwKChbLCBldmVudF0pID0+IGV2ZW50KSxcbiAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSxcbiAgKTtcblxuICByZWFkb25seSBoaWRlJDogT2JzZXJ2YWJsZTxFdmVudD4gPSB0aGlzLmNsaWNrJC5waXBlKFxuICAgIGZpbHRlcigoW3Nob3VsZFNob3csIGV2ZW50XSkgPT4gIXNob3VsZFNob3cgJiYgIXRoaXMuaXNPbkNvbnRhaW5lcihldmVudC50YXJnZXQgYXMgRWxlbWVudCkpLFxuICAgIG1hcCgoWywgZXZlbnRdKSA9PiBldmVudCksXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBzaG93IGFuZCBoaWRlIGV2ZW50IHN0cmVhbXMuXG4gKiBGaXJlcyBvcGVuIGV2ZW50IHdoZW4gYSBtb3VzZSBob3ZlcnMgb3ZlciB0aGUgaG9zdCBlbGVtZW50IGFuZCBzdGF5IG92ZXIgYXQgbGVhc3QgMTAwIG1pbGxpc2Vjb25kcy5cbiAqIEZpcmVzIGNsb3NlIGV2ZW50IHdoZW4gdGhlIG1vdXNlIGxlYXZlcyB0aGUgaG9zdCBlbGVtZW50IGFuZCBzdG9wcyBvdXQgb2YgdGhlIGhvc3QgYW5kIHBvcG92ZXIgY29udGFpbmVyLlxuICogKi9cbmV4cG9ydCBjbGFzcyBOYkhvdmVyVHJpZ2dlclN0cmF0ZWd5IGV4dGVuZHMgTmJUcmlnZ2VyU3RyYXRlZ3lCYXNlIHtcbiAgc2hvdyQ6IE9ic2VydmFibGU8RXZlbnQ+ID0gb2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5ob3N0LCAnbW91c2VlbnRlcicpLnBpcGUoXG4gICAgZmlsdGVyKCgpID0+ICF0aGlzLmNvbnRhaW5lcigpKSxcbiAgICAvLyB0aGlzIGBkZWxheSAmIHRha2VVbnRpbCAmIHJlcGVhdGAgb3BlcmF0b3JzIGNvbWJpbmF0aW9uIGlzIGEgc3lub255bSBmb3IgYGNvbmRpdGlvbmFsIGRlYm91bmNlYFxuICAgIC8vIG1lYW5pbmcgdGhhdCBpZiBvbmUgZXZlbnQgb2NjdXJzIGluIHNvbWUgdGltZSBhZnRlciB0aGUgaW5pdGlhbCBvbmUgd2Ugd29uJ3QgcmVhY3QgdG8gaXRcbiAgICBkZWxheSgxMDApLFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByeGpzL25vLXVuc2FmZS10YWtldW50aWxcbiAgICB0YWtlVW50aWwob2JzZXJ2YWJsZUZyb21FdmVudCh0aGlzLmhvc3QsICdtb3VzZWxlYXZlJykpLFxuICAgIHJlcGVhdCgpLFxuICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpLFxuICApO1xuXG4gIGhpZGUkOiBPYnNlcnZhYmxlPEV2ZW50PiA9IG9ic2VydmFibGVGcm9tRXZlbnQ8RXZlbnQ+KHRoaXMuaG9zdCwgJ21vdXNlbGVhdmUnKS5waXBlKFxuICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgb2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5kb2N1bWVudCwgJ21vdXNlbW92ZScpLnBpcGUoXG4gICAgICAgIGRlYm91bmNlVGltZSgxMDApLFxuICAgICAgICB0YWtlV2hpbGUoKCkgPT4gISF0aGlzLmNvbnRhaW5lcigpKSxcbiAgICAgICAgZmlsdGVyKChldmVudCkgPT4gdGhpcy5pc05vdE9uSG9zdE9yQ29udGFpbmVyKGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KSksXG4gICAgICApLFxuICAgICksXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBzaG93IGFuZCBoaWRlIGV2ZW50IHN0cmVhbXMuXG4gKiBGaXJlcyBvcGVuIGV2ZW50IHdoZW4gYSBtb3VzZSBob3ZlcnMgb3ZlciB0aGUgaG9zdCBlbGVtZW50IGFuZCBzdGF5IG92ZXIgYXQgbGVhc3QgMTAwIG1pbGxpc2Vjb25kcy5cbiAqIEZpcmVzIGNsb3NlIGV2ZW50IHdoZW4gdGhlIG1vdXNlIGxlYXZlcyB0aGUgaG9zdCBlbGVtZW50LlxuICogKi9cbmV4cG9ydCBjbGFzcyBOYkhpbnRUcmlnZ2VyU3RyYXRlZ3kgZXh0ZW5kcyBOYlRyaWdnZXJTdHJhdGVneUJhc2Uge1xuICBzaG93JDogT2JzZXJ2YWJsZTxFdmVudD4gPSBvYnNlcnZhYmxlRnJvbUV2ZW50PEV2ZW50Pih0aGlzLmhvc3QsICdtb3VzZWVudGVyJykucGlwZShcbiAgICAvLyB0aGlzIGBkZWxheSAmIHRha2VVbnRpbCAmIHJlcGVhdGAgb3BlcmF0b3JzIGNvbWJpbmF0aW9uIGlzIGEgc3lub255bSBmb3IgYGNvbmRpdGlvbmFsIGRlYm91bmNlYFxuICAgIC8vIG1lYW5pbmcgdGhhdCBpZiBvbmUgZXZlbnQgb2NjdXJzIGluIHNvbWUgdGltZSBhZnRlciB0aGUgaW5pdGlhbCBvbmUgd2Ugd29uJ3QgcmVhY3QgdG8gaXRcbiAgICBkZWxheSgxMDApLFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByeGpzL25vLXVuc2FmZS10YWtldW50aWxcbiAgICB0YWtlVW50aWwob2JzZXJ2YWJsZUZyb21FdmVudCh0aGlzLmhvc3QsICdtb3VzZWxlYXZlJykpLFxuICAgIHJlcGVhdCgpLFxuICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpLFxuICApO1xuXG4gIGhpZGUkOiBPYnNlcnZhYmxlPEV2ZW50PiA9IG9ic2VydmFibGVGcm9tRXZlbnQodGhpcy5ob3N0LCAnbW91c2VsZWF2ZScpLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgc2hvdyBhbmQgaGlkZSBldmVudCBzdHJlYW1zLlxuICogRmlyZXMgb3BlbiBldmVudCB3aGVuIGEgZm9jdXMgaXMgb24gdGhlIGhvc3QgZWxlbWVudCBhbmQgc3RheSBvdmVyIGF0IGxlYXN0IDEwMCBtaWxsaXNlY29uZHMuXG4gKiBGaXJlcyBjbG9zZSBldmVudCB3aGVuIHRoZSBmb2N1cyBsZWF2ZXMgdGhlIGhvc3QgZWxlbWVudC5cbiAqICovXG5leHBvcnQgY2xhc3MgTmJGb2N1c1RyaWdnZXJTdHJhdGVneSBleHRlbmRzIE5iVHJpZ2dlclN0cmF0ZWd5QmFzZSB7XG4gIHByb3RlY3RlZCBmb2N1c091dCQ6IE9ic2VydmFibGU8RXZlbnQ+ID0gb2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5ob3N0LCAnZm9jdXNvdXQnKS5waXBlKFxuICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgb2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5kb2N1bWVudCwgJ2ZvY3VzaW4nKS5waXBlKFxuICAgICAgICB0YWtlV2hpbGUoKCkgPT4gISF0aGlzLmNvbnRhaW5lcigpKSxcbiAgICAgICAgZmlsdGVyKChldmVudCkgPT4gdGhpcy5pc05vdE9uSG9zdE9yQ29udGFpbmVyKGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KSksXG4gICAgICApLFxuICAgICksXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICk7XG5cbiAgcHJvdGVjdGVkIGNsaWNrSW4kOiBPYnNlcnZhYmxlPEV2ZW50PiA9IG9ic2VydmFibGVGcm9tRXZlbnQ8RXZlbnQ+KHRoaXMuaG9zdCwgJ2NsaWNrJykucGlwZShcbiAgICBmaWx0ZXIoKCkgPT4gIXRoaXMuY29udGFpbmVyKCkpLFxuICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpLFxuICApO1xuXG4gIHByb3RlY3RlZCBjbGlja091dCQ6IE9ic2VydmFibGU8RXZlbnQ+ID0gb2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5kb2N1bWVudCwgJ2NsaWNrJykucGlwZShcbiAgICBmaWx0ZXIoKCkgPT4gISF0aGlzLmNvbnRhaW5lcigpKSxcbiAgICAvKipcbiAgICAgKiBFdmVudCB0YXJnZXQgb2YgYGNsaWNrYCBjb3VsZCBiZSBkaWZmZXJlbnQgZnJvbSBgYWN0aXZlRWxlbWVudGAuXG4gICAgICogSWYgZHVyaW5nIGNsaWNrIHlvdSByZXR1cm4gZm9jdXMgdG8gdGhlIGhvc3QsIGl0IHdvbid0IGJlIG9wZW5lZC5cbiAgICAgKi9cbiAgICBmaWx0ZXIoKGV2ZW50KSA9PiB7XG4gICAgICBpZiAodGhpcy5pc05vdE9uSG9zdE9yQ29udGFpbmVyKGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KSkge1xuICAgICAgICByZXR1cm4gdGhpcy5pc05vdE9uSG9zdE9yQ29udGFpbmVyKHRoaXMuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSksXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICk7XG5cbiAgcHJvdGVjdGVkIHRhYktleVByZXNzJDogT2JzZXJ2YWJsZTxFdmVudD4gPSBvYnNlcnZhYmxlRnJvbUV2ZW50PEV2ZW50Pih0aGlzLmRvY3VtZW50LCAna2V5ZG93bicpLnBpcGUoXG4gICAgZmlsdGVyKChldmVudDogRXZlbnQpID0+IChldmVudCBhcyBLZXlib2FyZEV2ZW50KS5rZXlDb2RlID09PSA5KSxcbiAgICBmaWx0ZXIoKCkgPT4gISF0aGlzLmNvbnRhaW5lcigpKSxcbiAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSxcbiAgKTtcblxuICBzaG93JDogT2JzZXJ2YWJsZTxFdmVudD4gPSBvYnNlcnZhYmxlTWVyZ2Uob2JzZXJ2YWJsZUZyb21FdmVudDxFdmVudD4odGhpcy5ob3N0LCAnZm9jdXNpbicpLCB0aGlzLmNsaWNrSW4kKS5waXBlKFxuICAgIGZpbHRlcigoKSA9PiAhdGhpcy5jb250YWluZXIoKSksXG4gICAgZGVib3VuY2VUaW1lKDEwMCksXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJ4anMvbm8tdW5zYWZlLXRha2V1bnRpbFxuICAgIHRha2VVbnRpbChvYnNlcnZhYmxlRnJvbUV2ZW50KHRoaXMuaG9zdCwgJ2ZvY3Vzb3V0JykpLFxuICAgIHJlcGVhdCgpLFxuICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpLFxuICApO1xuXG4gIGhpZGUkID0gb2JzZXJ2YWJsZU1lcmdlKHRoaXMuZm9jdXNPdXQkLCB0aGlzLnRhYktleVByZXNzJCwgdGhpcy5jbGlja091dCQpLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgZW1wdHkgc2hvdyBhbmQgaGlkZSBldmVudCBzdHJlYW1zLlxuICogKi9cbmV4cG9ydCBjbGFzcyBOYk5vb3BUcmlnZ2VyU3RyYXRlZ3kgZXh0ZW5kcyBOYlRyaWdnZXJTdHJhdGVneUJhc2Uge1xuICBzaG93JDogT2JzZXJ2YWJsZTxFdmVudD4gPSBFTVBUWTtcbiAgaGlkZSQ6IE9ic2VydmFibGU8RXZlbnQ+ID0gRU1QVFk7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOYlRyaWdnZXJTdHJhdGVneUJ1aWxkZXJTZXJ2aWNlIHtcbiAgcHJvdGVjdGVkIF9ob3N0OiBIVE1MRWxlbWVudDtcbiAgcHJvdGVjdGVkIF9jb250YWluZXI6ICgpID0+IENvbXBvbmVudFJlZjxhbnk+O1xuICBwcm90ZWN0ZWQgX3RyaWdnZXI6IE5iVHJpZ2dlcjtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KE5CX0RPQ1VNRU5UKSBwcm90ZWN0ZWQgX2RvY3VtZW50KSB7fVxuXG4gIHRyaWdnZXIodHJpZ2dlcjogTmJUcmlnZ2VyKTogdGhpcyB7XG4gICAgdGhpcy5fdHJpZ2dlciA9IHRyaWdnZXI7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBob3N0KGhvc3Q6IEhUTUxFbGVtZW50KTogdGhpcyB7XG4gICAgdGhpcy5faG9zdCA9IGhvc3Q7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjb250YWluZXIoY29udGFpbmVyOiAoKSA9PiBDb21wb25lbnRSZWY8YW55Pik6IHRoaXMge1xuICAgIHRoaXMuX2NvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGJ1aWxkKCk6IE5iVHJpZ2dlclN0cmF0ZWd5IHtcbiAgICBzd2l0Y2ggKHRoaXMuX3RyaWdnZXIpIHtcbiAgICAgIGNhc2UgTmJUcmlnZ2VyLkNMSUNLOlxuICAgICAgICByZXR1cm4gbmV3IE5iQ2xpY2tUcmlnZ2VyU3RyYXRlZ3kodGhpcy5fZG9jdW1lbnQsIHRoaXMuX2hvc3QsIHRoaXMuX2NvbnRhaW5lcik7XG4gICAgICBjYXNlIE5iVHJpZ2dlci5ISU5UOlxuICAgICAgICByZXR1cm4gbmV3IE5iSGludFRyaWdnZXJTdHJhdGVneSh0aGlzLl9kb2N1bWVudCwgdGhpcy5faG9zdCwgdGhpcy5fY29udGFpbmVyKTtcbiAgICAgIGNhc2UgTmJUcmlnZ2VyLkhPVkVSOlxuICAgICAgICByZXR1cm4gbmV3IE5iSG92ZXJUcmlnZ2VyU3RyYXRlZ3kodGhpcy5fZG9jdW1lbnQsIHRoaXMuX2hvc3QsIHRoaXMuX2NvbnRhaW5lcik7XG4gICAgICBjYXNlIE5iVHJpZ2dlci5GT0NVUzpcbiAgICAgICAgcmV0dXJuIG5ldyBOYkZvY3VzVHJpZ2dlclN0cmF0ZWd5KHRoaXMuX2RvY3VtZW50LCB0aGlzLl9ob3N0LCB0aGlzLl9jb250YWluZXIpO1xuICAgICAgY2FzZSBOYlRyaWdnZXIuTk9PUDpcbiAgICAgICAgcmV0dXJuIG5ldyBOYk5vb3BUcmlnZ2VyU3RyYXRlZ3kodGhpcy5fZG9jdW1lbnQsIHRoaXMuX2hvc3QsIHRoaXMuX2NvbnRhaW5lcik7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyaWdnZXIgaGF2ZSB0byBiZSBwcm92aWRlZCcpO1xuICAgIH1cbiAgfVxufVxuIl19